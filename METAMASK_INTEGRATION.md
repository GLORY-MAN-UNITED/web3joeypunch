# Web3 Joey Pouch - MetaMask 集成说明

## 功能概述

本项目已成功集成 MetaMask 钱包功能，允许用户在注册时绑定自己的以太坊钱包地址，以便服务器能够存储用户的公钥地址，用于后续的转账操作。

## 新增功能

### 1. 用户注册时绑定 MetaMask
- 用户注册页面现在包含 MetaMask 钱包连接功能
- 必须连接 MetaMask 钱包才能完成注册
- 系统会验证钱包地址格式的正确性
- 每个钱包地址只能绑定一个账户

### 2. 用户个人资料管理
- 新增 `/profile` 页面，用户可以查看和管理自己的账户信息
- 显示当前绑定的钱包地址
- 支持更换绑定的钱包地址

### 3. 钱包信息显示
- 导航栏显示用户绑定的钱包地址（简化格式）
- 个人资料页面显示完整的钱包地址
- 连接状态实时显示

## 技术实现

### 前端集成
- 使用 `window.ethereum` API 与 MetaMask 交互
- 实现钱包连接、账户获取等功能
- 友好的用户界面提示和错误处理

### 后端存储
- 数据库 `users` 表新增 `wallet_address` 字段
- 钱包地址唯一性约束
- 地址格式验证（以太坊地址格式）

### 安全措施
- 钱包地址格式验证
- 防止重复绑定
- 用户身份验证

## 使用步骤

### 新用户注册
1. 访问注册页面 `/register`
2. 点击 "Connect MetaMask" 按钮
3. 在 MetaMask 弹窗中确认连接
4. 填写用户名和密码
5. 点击注册按钮完成注册

### 现有用户绑定钱包
1. 登录账户
2. 访问个人资料页面 `/profile`
3. 点击 "Connect MetaMask" 按钮
4. 确认钱包连接

### 更换绑定钱包
1. 在个人资料页面点击 "Update Wallet"
2. 点击 "Connect New Wallet"
3. 连接新的 MetaMask 账户
4. 确认更新

## API 端点

### 钱包相关 API
- `GET /api/user/wallet` - 获取用户钱包信息
- `POST /api/user/wallet` - 更新用户钱包地址
- `POST /api/register` - 注册用户（需要钱包地址）

### 响应格式
```json
{
  "success": true,
  "walletAddress": "0x742d35Cc...",
  "message": "操作成功"
}
```

## 数据库结构

### users 表新增字段
```sql
ALTER TABLE users ADD COLUMN wallet_address TEXT UNIQUE;
```

## 文件修改清单

### 后端文件
- `server.js` - 主服务器文件，添加钱包相关路由和功能
- `database.js` - 数据库初始化，添加钱包地址字段
- `migrate-db.js` - 数据库迁移脚本（新文件）

### 前端文件
- `public/script.js` - 添加 MetaMask 集成功能
- `public/style.css` - 添加钱包相关样式

### 依赖包
- `web3` - Web3 JavaScript 库
- `ethers` - 以太坊 JavaScript 库

## 注意事项

1. **MetaMask 要求**: 用户必须安装 MetaMask 浏览器扩展
2. **网络要求**: 确保 MetaMask 连接到正确的以太坊网络
3. **地址唯一性**: 每个钱包地址只能绑定一个用户账户
4. **数据迁移**: 现有用户需要手动在个人资料页面绑定钱包

## 后续扩展

基于当前的钱包集成，可以进一步实现：

1. **代币转账功能**: 服务器可以向用户钱包地址发送代币奖励
2. **智能合约集成**: 与自定义 ERC-20 代币合约交互
3. **交易历史**: 记录和显示用户的代币交易历史
4. **钱包余额查询**: 实时显示用户钱包中的代币余额

## 测试建议

1. 测试新用户注册流程
2. 测试现有用户绑定钱包
3. 测试钱包地址更换功能
4. 测试重复绑定防护
5. 测试 MetaMask 未安装的情况

---

现在您的 Web3 Joey Pouch 项目已经成功集成了 MetaMask 钱包功能！用户可以在注册时绑定自己的钱包地址，服务器可以存储这些地址用于后续的转账操作。